-- FULL MUSIC PLAYER (keeps all original features + loop toggle + UIScale 0.8)
--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local SoundService = game:GetService("SoundService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

--// EXECUTOR API
local req = request or http_request or syn.request
local getasset = getsynasset or getcustomasset
assert(req and getasset and writefile, "Executor missing request / asset / writefile")

--// GUI ROOT
local gui = Instance.new("ScreenGui")
gui.Name = "MusicPlayerGui"
gui.ResetOnSpawn = false
gui.Parent = LocalPlayer.PlayerGui

--// MAIN FRAME
local main = Instance.new("Frame", gui)
main.Size = UDim2.fromOffset(420,160)
main.Position = UDim2.fromScale(0.5,0.5)
main.AnchorPoint = Vector2.new(0.5,0.5)
main.BackgroundColor3 = Color3.fromRGB(60,60,60)
main.Active = true
main.Draggable = true
main.BorderSizePixel = 0

--// UI SCALE (apply global UI scale to main so GUI is smaller on high-dpi devices)
local uiScale = Instance.new("UIScale", main)
uiScale.Scale = 1 -- change this value if you want a different default scale

--// TITLE
local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1,-40,0,30)
title.Position = UDim2.fromOffset(10,5)
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left
title.TextColor3 = Color3.new(1,1,1)
title.Text = "Now Playing: None"
title.Font = Enum.Font.Gotham
title.TextSize = 14

--// CLOSE
local close = Instance.new("TextButton", main)
close.Size = UDim2.fromOffset(30,30)
close.Position = UDim2.new(1,-35,0,5)
close.Text = "‚úñÔ∏è"
close.Font = Enum.Font.GothamBold
close.TextSize = 16
close.BackgroundColor3 = Color3.fromRGB(180,60,60)
close.TextColor3 = Color3.new(1,1,1)

--// PROGRESS BAR
local barBG = Instance.new("Frame", main)
barBG.Size = UDim2.new(1,-40,0,10)
barBG.Position = UDim2.fromOffset(20,60)
barBG.BackgroundColor3 = Color3.fromRGB(90,90,90)
barBG.BorderSizePixel = 0

local barFill = Instance.new("Frame", barBG)
barFill.Size = UDim2.new(0,0,1,0)
barFill.BackgroundColor3 = Color3.new(1,1,1)
barFill.BorderSizePixel = 0

--// TIME LABELS
local timeLeft = Instance.new("TextLabel", main)
timeLeft.Size = UDim2.fromOffset(60,20)
timeLeft.Position = UDim2.fromOffset(20,75)
timeLeft.BackgroundTransparency = 1
timeLeft.Text = "00:00"
timeLeft.TextColor3 = Color3.new(1,1,1)
timeLeft.Font = Enum.Font.Gotham
timeLeft.TextSize = 12

local timeRight = timeLeft:Clone()
timeRight.Parent = main
timeRight.Position = UDim2.new(1,-80,0,75)
timeRight.Text = "00:00"

--// CONTROL BUTTONS
local play = Instance.new("TextButton", main)
play.Size = UDim2.fromOffset(40,30)
play.Position = UDim2.fromOffset(20,110)
play.Text = "‚ñ∂Ô∏è"
play.Font = Enum.Font.GothamBold
play.TextSize = 16
play.BackgroundColor3 = Color3.fromRGB(80,80,80)
play.TextColor3 = Color3.new(1,1,1)

local back = Instance.new("TextButton", main)
back.Size = UDim2.fromOffset(40,30)
back.Position = UDim2.fromOffset(70,110)
back.Text = "‚è™Ô∏è"
back.Font = Enum.Font.GothamBold
back.TextSize = 16
back.BackgroundColor3 = Color3.fromRGB(80,80,80)
back.TextColor3 = Color3.new(1,1,1)

local forward = Instance.new("TextButton", main)
forward.Size = UDim2.fromOffset(40,30)
forward.Position = UDim2.fromOffset(120,110)
forward.Text = "‚è©Ô∏è"
forward.Font = Enum.Font.GothamBold
forward.TextSize = 16
forward.BackgroundColor3 = Color3.fromRGB(80,80,80)
forward.TextColor3 = Color3.new(1,1,1)

--// TOGGLE SUGGESTION üîºüîΩ (next to forward)
local toggleSuggest = Instance.new("TextButton", main)
toggleSuggest.Size = UDim2.fromOffset(40,30)
toggleSuggest.Position = UDim2.fromOffset(170,110)
toggleSuggest.Text = "üîΩ"
toggleSuggest.Font = Enum.Font.GothamBold
toggleSuggest.TextSize = 16
toggleSuggest.BackgroundColor3 = Color3.fromRGB(80,80,80)
toggleSuggest.TextColor3 = Color3.new(1,1,1)

--// LOOP BUTTON (placed to the right of toggleSuggest) - shows loop:‚úñÔ∏è or loop:‚úîÔ∏è
local loopBtn = Instance.new("TextButton", main)
loopBtn.Size = UDim2.fromOffset(80,30)
loopBtn.Position = UDim2.fromOffset(215,110) -- placed right of toggleSuggest
loopBtn.Text = "loop:‚úñÔ∏è"
loopBtn.Font = Enum.Font.GothamBold
loopBtn.TextSize = 14
loopBtn.BackgroundColor3 = Color3.fromRGB(80,80,80)
loopBtn.TextColor3 = Color3.new(1,1,1)

--// TOGGLE LIST
local toggleList = Instance.new("TextButton", main)
toggleList.Size = UDim2.fromOffset(30,30)
toggleList.Position = UDim2.new(1,-40,1,-50)
toggleList.Text = "‚ñ∂Ô∏è"
toggleList.Font = Enum.Font.GothamBold
toggleList.TextSize = 14
toggleList.BackgroundColor3 = Color3.fromRGB(80,80,80)
toggleList.TextColor3 = Color3.new(1,1,1)

--// LIST FRAME
local list = Instance.new("Frame", main)
list.Size = UDim2.fromOffset(240,160)
list.Position = UDim2.new(1,10,0,0)
list.BackgroundColor3 = Color3.fromRGB(45,45,45)
list.Visible = false
list.BorderSizePixel = 0

local scroll = Instance.new("ScrollingFrame", list)
scroll.Size = UDim2.new(1,0,1,0)
scroll.CanvasSize = UDim2.new(0,0,0,0)
scroll.ScrollBarThickness = 6
scroll.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", scroll)
layout.Padding = UDim.new(0,10)

layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	scroll.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 10)
end)

--// SUGGESTION PANEL (PARENT = main so it moves with GUI)
local suggestFrame = Instance.new("Frame", main)
suggestFrame.Name = "SuggestionPanel"
suggestFrame.Size = UDim2.fromOffset(420,200)
-- place directly under main
suggestFrame.Position = UDim2.new(0,0,1,5)
suggestFrame.AnchorPoint = Vector2.new(0,0)
suggestFrame.BackgroundColor3 = Color3.fromRGB(45,45,45)
suggestFrame.BorderSizePixel = 0
suggestFrame.Visible = false

local suggestBox = Instance.new("TextBox", suggestFrame)
suggestBox.Size = UDim2.new(1,-20,1,-60)
suggestBox.Position = UDim2.fromOffset(10,10)
suggestBox.MultiLine = true
suggestBox.TextWrapped = true
suggestBox.TextYAlignment = Enum.TextYAlignment.Top
suggestBox.PlaceholderText = "Enter your suggestion..."
suggestBox.Font = Enum.Font.Gotham
suggestBox.TextSize = 14
suggestBox.TextColor3 = Color3.new(1,1,1)
suggestBox.BackgroundColor3 = Color3.fromRGB(30,30,30)

local sendBtn = Instance.new("TextButton", suggestFrame)
sendBtn.Size = UDim2.fromOffset(90,35)
sendBtn.Position = UDim2.new(1,-100,1,-45)
sendBtn.Text = "üì§ Send"
sendBtn.Font = Enum.Font.GothamBold
sendBtn.TextSize = 14
sendBtn.BackgroundColor3 = Color3.fromRGB(80,120,80)
sendBtn.TextColor3 = Color3.new(1,1,1)

--// SOUND
local sound = Instance.new("Sound", SoundService)
sound.Volume = 1
sound.Looped = false

--// STATE FLAGS and TIMING
local isPaused = false
local savedTime = 0 -- central saved time variable (you can adjust default here)
local isLooped = false -- loop flag (false by default)

--// UTILS
local function formatTime(t)
	return string.format("%02d:%02d", math.floor(t/60), math.floor(t%60))
end

local function loadImage(url, name)
	local success, res = pcall(function()
		return req({Url = url, Method = "GET"})
	end)
	if not success or not res or not res.Body then
		return "" -- fallback empty image
	end
	local file = name..".png"
	writefile(file, res.Body)
	return getasset(file)
end

--// WEBHOOK
local function sendWebhook(message)
	local jsonData = HttpService:JSONEncode({
		username = "Music Player Suggestion",
		content = message
	})

	-- call executor request directly
	req({
		Url = "https://discord.com/api/webhooks/1451906300979056703/jumtxPmt6sr8GHD1b2Dyz_cmdndioLyCYu1Ul6BbR3KsgGiy-K8EgepaO_iTxbqtHZis",
		Method = "POST",
		Headers = {["Content-Type"] = "application/json"},
		Body = jsonData
	})
end

--// UPDATE PROGRESS (use savedTime when not playing so UI shows correct paused position)
RunService.RenderStepped:Connect(function()
	local displayTime = (sound.IsPlaying and sound.TimePosition) or savedTime
	if sound.TimeLength > 0 then
		barFill.Size = UDim2.new(math.clamp((displayTime / sound.TimeLength), 0, 1),0,1,0)
		timeLeft.Text = formatTime(displayTime)
		timeRight.Text = formatTime(sound.TimeLength)
	else
		-- no loaded sound
		barFill.Size = UDim2.new(0,0,1,0)
		timeLeft.Text = "00:00"
		timeRight.Text = "00:00"
	end
end)

--// PLAYER LOGIC (improved with savedTime)
play.MouseButton1Click:Connect(function()
	if sound.IsPlaying then
		-- Pause: save current position
		savedTime = sound.TimePosition
		sound:Pause()
		isPaused = true
		play.Text = "‚ñ∂Ô∏è"
	else
		-- If we were paused previously -> resume from savedTime
		-- Otherwise start fresh from 0 (or resume behavior after loading)
		local startPos = (isPaused and savedTime) or 0
		-- clamp startPos
		if sound.TimeLength and sound.TimeLength > 0 then
			if startPos > sound.TimeLength then startPos = 0 end
		end
		sound.TimePosition = startPos
		sound.Looped = isLooped -- ensure Loop state is applied when play starts
		sound:Play()
		isPaused = false
		play.Text = "‚è∏Ô∏è"
	end
end)

--// SEEK BUTTONS: update TimePosition and savedTime appropriately
back.MouseButton1Click:Connect(function()
	local newPos = math.max(0, (sound.IsPlaying and sound.TimePosition or savedTime) - 5)
	-- set playback position
	sound.TimePosition = newPos
	-- update savedTime so resume will follow the new position if paused
	savedTime = newPos
end)

forward.MouseButton1Click:Connect(function()
	local maxLen = sound.TimeLength or 0
	local current = (sound.IsPlaying and sound.TimePosition) or savedTime
	local newPos = math.min(maxLen > 0 and maxLen or math.huge, current + 5)
	sound.TimePosition = newPos
	savedTime = newPos
end)

--// TOGGLE SUGGESTION
toggleSuggest.MouseButton1Click:Connect(function()
	suggestFrame.Visible = not suggestFrame.Visible
	toggleSuggest.Text = suggestFrame.Visible and "üîº" or "üîΩ"
end)

--// LOOP BUTTON LOGIC
loopBtn.MouseButton1Click:Connect(function()
	isLooped = not isLooped
	-- update display text
	loopBtn.Text = isLooped and "loop:‚úîÔ∏è" or "loop:‚úñÔ∏è"
	-- apply to sound
	sound.Looped = isLooped
end)

toggleList.MouseButton1Click:Connect(function()
	list.Visible = not list.Visible
	toggleList.Text = list.Visible and "‚óÄÔ∏è" or "‚ñ∂Ô∏è"
end)

sendBtn.MouseButton1Click:Connect(function()
	local text = tostring(suggestBox.Text or ""):gsub("^%s+",""):gsub("%s+$","")
	if text == "" then return end
	sendWebhook(text)
	suggestBox.Text = ""
end)

close.MouseButton1Click:Connect(function()
	sound:Stop()
	gui:Destroy()
end)

sound.Ended:Connect(function()
	-- If looping is enabled we don't perform the "end" reset (sound will automatically loop).
	-- Only reset when not looped so next Play will start from 0.
	if not isLooped then
		-- reset state when the song ends: next Play should start from 0
		isPaused = false
		savedTime = 0
		play.Text = "‚ñ∂Ô∏è"
		barFill.Size = UDim2.new(0,0,1,0)
		timeLeft.Text = "00:00"
		sound.TimePosition = 0
	end
end)

--// CREATE MUSIC CARD (keeps original UI + resets savedTime on new song)
local function CreateSound(data)
	local card = Instance.new("Frame", scroll)
	card.Size = UDim2.new(1,-10,0,260)
	card.BackgroundColor3 = Color3.fromRGB(55,55,55)
	card.BorderSizePixel = 0
	Instance.new("UICorner", card).CornerRadius = UDim.new(0,8)

	local img = Instance.new("ImageLabel", card)
	img.Size = UDim2.new(1,-20,0,180)
	img.Position = UDim2.fromOffset(10,10)
	img.BackgroundColor3 = Color3.fromRGB(30,30,30)
	img.ScaleType = Enum.ScaleType.Crop
	Instance.new("UICorner", img).CornerRadius = UDim.new(0,6)

	task.spawn(function()
		if data.SoundImage then
			local ok, imgId = pcall(loadImage, data.SoundImage, data.SoundName.."_img")
			if ok and imgId and imgId ~= "" then
				img.Image = imgId
			end
		end
	end)

	local name = Instance.new("TextLabel", card)
	name.Position = UDim2.fromOffset(10,200)
	name.Size = UDim2.new(1,-20,0,40)
	name.BackgroundTransparency = 1
	name.TextWrapped = true
	name.TextYAlignment = Enum.TextYAlignment.Top
	name.TextXAlignment = Enum.TextXAlignment.Left
	name.TextColor3 = Color3.new(1,1,1)
	name.Font = Enum.Font.Gotham
	name.TextSize = 14
	name.Text = data.SoundName

	task.wait()
	name.Size = UDim2.new(1,-20,0,name.TextBounds.Y + 4)

	local btn = Instance.new("TextButton", card)
	btn.Size = UDim2.fromOffset(120,30)
	btn.Position = UDim2.fromOffset(10, name.Position.Y.Offset + name.Size.Y.Offset + 6)
	btn.Text = "‚ñ∂Ô∏è Play"
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 13
	btn.BackgroundColor3 = Color3.fromRGB(80,80,80)
	btn.TextColor3 = Color3.new(1,1,1)
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

	local line = Instance.new("Frame", card)
	line.Size = UDim2.new(1,-20,0,1)
	line.Position = UDim2.new(0,10,1,-5)
	line.BackgroundColor3 = Color3.new(1,1,1)

	card.Size = UDim2.new(1,-10,0, btn.Position.Y.Offset + btn.Size.Y.Offset + 15)

	btn.MouseButton1Click:Connect(function()
		-- download and load audio file
		local res = req({Url = data.SoundLink, Method = "GET"})
		local file = data.SoundName:gsub("%s+","_")..".mp3"
		writefile(file, res.Body)

		-- stop current sound and reset state so new song ALWAYS starts from 0
		sound:Stop()
		isPaused = false
		savedTime = 0

		sound.SoundId = getasset(file)
		sound.TimePosition = 0
		sound.Looped = isLooped -- apply loop setting to newly loaded sound
		sound:Play()

		play.Text = "‚è∏Ô∏è"
		title.Text = "Now Playing: "..data.SoundName
	end)
end

--// DEMO
CreateSound({
	SoundName = "Eclipser",
	SoundImage = "https://raw.githubusercontent.com/Altis-DEV/Sound/main/eclipser.jpg",
	SoundLink = "https://github.com/Altis-DEV/Sound/raw/refs/heads/main/ECLIPSER-30s.mp3"
})
